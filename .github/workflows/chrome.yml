name: chrome

on:
  workflow_call:
    inputs:
      os-version:
        type: string
        default: ubuntu-latest

permissions:
  contents: read

jobs:
  setup-chrome:
    runs-on: ${{ inputs.os-version }}

    steps:
      - name: install chrome
        uses: browser-actions/setup-chrome@v2
        id: setup-chrome
        with:
          install-dependencies: true

      - name: init chrome linux
        if: ${{ runner.os == 'linux' }}
        run: |
          chrome --version
          chrome --headless --disable-gpu --no-sandbox --remote-debugging-port=9222 about:blank &
           CHROME_PID=$!

           # Wait up to 30s for Chrome to create the NSS DB
           for i in {1..30}; do
             if [ -d "$HOME/.pki/nssdb" ]; then
               echo "✅ NSS DB found"
               break
             fi
           echo "⏳ Waiting for NSS DB to be created... ($i)"
           sleep 1
           done

           kill $CHROME_PID

           if [ ! -d "$HOME/.pki/nssdb" ]; then
             echo "❌ NSS DB was not created after 30s"
             exit 1
           fi

      - name: init chrome windows
        if: ${{ runner.os == 'windows' }}
        run: |
          & "C:\Program Files\Google\Chrome\Application\chrome.exe" --version
          & "C:\Program Files\Google\Chrome\Application\chrome.exe" --headless --disable-gpu --remote-debugging-port=9222 about:blank
          Start-Sleep -Seconds 5

      - name: init chrome macos
        if: ${{ runner.os == 'macos' }}
        run: |
          /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --version
          /Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome --headless --disable-gpu --no-sandbox --remote-debugging-port=9222 about:blank &
          CHROME_PID=$!

          # Wait up to 30s for Chrome to create the NSS DB
          for i in {1..30}; do
            if [ -d "$HOME/Library/Application Support/Google/Chrome/Default" ]; then
              echo "✅ Default profile created"
              break
            fi
            echo "⏳ Waiting for Default profile to be created... ($i)"
            ls -l "$HOME/Library/Application Support/Google/Chrome/"
            sleep 1
          done

          kill $CHROME_PID

          if [ ! -d "$HOME/Library/Application Support/Google/Chrome/Default" ]; then
            echo "❌ Default profile was not created after 30s"
            exit 1
          fi
