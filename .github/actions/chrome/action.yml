name: chrome
description: "set up Chrome environment"
outputs:
  chrome-path:
    description: "Path to the chrome executable"
    value: ${{ steps.setup-chrome.outputs.chrome-path }}
  chrome-user-data-dir:
    description: "Path to the chrome user data directory"
    value: ${{ steps.chrome-user-data-dir.outputs.chrome-user-data-dir }}

runs:
  using: "composite"
  steps:
    - name: install chrome
      uses: browser-actions/setup-chrome@v2
      id: setup-chrome
      with:
        chrome-version: stable

    - name: init chrome Linux
      shell: bash
      id: chrome-user-data-dir
      if: ${{ runner.os == 'Linux' }}
      run: |
        chrome --version
        chrome --headless --disable-gpu --no-sandbox --remote-debugging-port=9222 about:blank &
          CHROME_PID=$!
          waitforfiles --initial=5s --interval=1s --total=30s "$HOME/.pki/nssdb"
          if [ $? -ne 0 ]; then
            kill $CHROME_PID
            exit 1
          fi
          kill $CHROME_PID

          USERDATA_DIR="/home/runner/.config/google-chrome-for-testing"
          echo "chrome-user-data-dir=$USERDATA_DIR" >> $GITHUB_OUTPUT

    - name: init chrome Windows
      shell: pwsh
      id: chrome-user-data-dir
      if: ${{ runner.os == 'Windows' }}
      run: |
        $chromePath = "${{ steps.setup-chrome.outputs.chrome-path }}"
        (Get-Item "$chromePath").VersionInfo.ProductVersion

        & "$chromePath" --headless --disable-gpu --remote-debugging-port=9222 about:blank
        $profilePath = "$env:LOCALAPPDATA\Google\Chrome\User Data\Default"
        echo "chrome-user-data-dir=$env:LOCALAPPDATA\Google\Chrome\User Data" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

        $goBinPath = (go env GOBIN)
        if (-not $goBinPath) {
          $goBinPath = (go env GOPATH) + "\bin"
        }

        & "$goBinPath\waitfor.exe" --initial=5s --interval=1s --total=30s $profilePath

    - name: init chrome macOS
      shell: bash
      id: chrome-user-data-dir
      if: ${{ runner.os == 'macOS' }}
      run: |
        CHROME_PATH="${{ steps.setup-chrome.outputs.chrome-path }}"
        "$CHROME_PATH" --version
        export HOME=/Users/runner
        USERDATA_DIR="$HOME/Library/Application Support/Google/Chrome for Testing"
        PROFILE_DIR="$USERDATA_DIR/Default"
        echo $USERDATA_DIR

        mkdir -p "$PROFILE_DIR"

        "$CHROME_PATH" --headless=new --disable-gpu --no-sandbox --remote-debugging-port=9222 --disable-dev-shm-usage --user-data-dir="$USERDATA_DIR" about:blank &
        CHROME_PID=$!

        waitforfiles --initial=2s --interval=1s --total=30s "$PROFILE_DIR"
        if [ $? -ne 0 ]; then
          kill $CHROME_PID
          exit 1
        fi
        kill $CHROME_PID

        echo "chrome-user-data-dir=$USERDATA_DIR" >> $GITHUB_OUTPUT
