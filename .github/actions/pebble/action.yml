name: pebble
description: "set up Pebble environment"
runs:
  using: "composite"
  steps:
    - name: install pebble and minica
      run: |
        go install github.com/letsencrypt/pebble/v2/cmd/pebble@latest
        go install github.com/jsha/minica@latest

    - name: init pebble hosts Windows
      # Use PowerShell (the default shell on Windows runners)
      if: ${{ runner.os == 'Windows' }}
      run: |
        Add-Content -Path $env:WINDIR\System32\drivers\etc\hosts -Value "127.0.0.1 pebble.example.com pebble-test.example.com"
        Get-Content -Path $env:WINDIR\System32\drivers\etc\hosts
      shell: pwsh

    - name: init pebble hosts Linux or macOS
      if: ${{ runner.os == 'Linux' || runner.os == 'macOS' }}
      run: |
        echo "127.0.0.1 pebble.example.com pebble-test.example.com" | sudo tee -a /etc/hosts
        cat /etc/hosts

    - name: test pebble hosts on Linux or macOS
      if: ${{ runner.os == 'Linux' || runner.os == 'macOS' }}
      run: |
        ping -c 2 pebble-test.example.com
        ping -c 2 pebble.example.com

    - name: test pebble hosts on Windows
      if: ${{ runner.os == 'Windows' }}
      run: |
        ping -n 2 pebble-test.example.com
        ping -n 2 pebble.example.com
      shell: pwsh
